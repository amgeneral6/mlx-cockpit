<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MLX Server Dashboard</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
         background: #0d1117; color: #c9d1d9; padding: 24px; }
  h1 { color: #58a6ff; margin-bottom: 4px; font-size: 1.5rem; }
  #status { font-size: 0.75rem; color: #3fb950; margin-bottom: 16px; }
  .tabs { display: flex; gap: 4px; margin-bottom: 20px; }
  .tab { padding: 8px 20px; border-radius: 8px 8px 0 0; border: 1px solid #30363d;
         border-bottom: none; background: #161b22; color: #8b949e; cursor: pointer;
         font-size: 0.85rem; font-weight: 600; letter-spacing: 0.03em; transition: all 0.15s; }
  .tab:hover { color: #c9d1d9; background: #1c2128; }
  .tab.active { background: #0d1117; border-bottom: 2px solid #0d1117;
                position: relative; top: 1px; }
  .tab .dot { display: inline-block; width: 7px; height: 7px; border-radius: 50%;
              margin-right: 6px; vertical-align: middle; }
  .dot.on { background: #3fb950; box-shadow: 0 0 6px #3fb950; }
  .dot.off { background: #f85149; box-shadow: 0 0 6px #f85149; }
  .panel { display: none; }
  .panel.active { display: block; }
  .cards { display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
  .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px;
          padding: 16px 24px; min-width: 180px; flex: 1; }
  .card .label { font-size: 0.75rem; color: #8b949e; text-transform: uppercase;
                 letter-spacing: 0.05em; margin-bottom: 4px; }
  .card .value { font-size: 1.6rem; font-weight: 600; }
  table { width: 100%; border-collapse: collapse; background: #161b22;
          border: 1px solid #30363d; border-radius: 8px; overflow: hidden; }
  th { background: #21262d; color: #8b949e; font-size: 0.75rem;
       text-transform: uppercase; letter-spacing: 0.05em; padding: 10px 12px;
       text-align: left; }
  td { padding: 8px 12px; border-top: 1px solid #21262d; font-size: 0.85rem; }
  tr:hover td { background: #1c2128; }
  .num { text-align: right; font-variant-numeric: tabular-nums; }
  .muted { color: #8b949e; }
  .offline-msg { text-align: center; padding: 48px 0; color: #484f58; font-size: 0.9rem; }
</style>
</head>
<body>
<h1>MLX Server Dashboard</h1>
<div id="status">Connecting...</div>
<div class="tabs" id="tabs"></div>
<div id="panels"></div>

<script>
const SCAN_PORTS = [8080,8081,8082,8083,8084,8085,8086,8087,8088,8089,8090];
const MODEL_COLORS = ["#58a6ff","#d2a8ff","#3fb950","#f97316","#ec4899"];
let activePort = null;

function switchTab(port) {
  activePort = port;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  const tab = document.getElementById('tab-' + port);
  const panel = document.getElementById('panel-' + port);
  if (tab) tab.classList.add('active');
  if (panel) panel.classList.add('active');
}

function renderTabs(services) {
  const tabsEl = document.getElementById('tabs');
  tabsEl.innerHTML = '';
  services.forEach((svc, i) => {
    const color = MODEL_COLORS[i % MODEL_COLORS.length];
    const div = document.createElement('div');
    div.className = 'tab' + (svc.port === activePort ? ' active' : '');
    div.id = 'tab-' + svc.port;
    div.style.color = svc.port === activePort ? color : '';
    div.onclick = () => switchTab(svc.port);
    let modelName = 'Port ' + svc.port;
    if (svc.data.requests && svc.data.requests.length > 0) {
      modelName = svc.data.requests[svc.data.requests.length - 1].model.split('/').pop();
    } else if (svc.data.health_model) {
      modelName = svc.data.health_model.split('/').pop();
    }
    div.innerHTML = '<span class="dot on"></span>' + modelName;
    tabsEl.appendChild(div);
  });
}

function renderPanels(services) {
  const panelsEl = document.getElementById('panels');
  panelsEl.innerHTML = '';
  services.forEach((svc, i) => {
    const color = MODEL_COLORS[i % MODEL_COLORS.length];
    const d = svc.data;
    const div = document.createElement('div');
    div.className = 'panel' + (svc.port === activePort ? ' active' : '');
    div.id = 'panel-' + svc.port;

    const s = d.summary || {};
    let contentHtml = '';

    if (svc.healthOnly) {
      // Health-only server (unpatched — no metrics endpoint)
      const hModel = d.health_model ? d.health_model : 'Unknown';
      contentHtml += '<div class="cards">';
      contentHtml += '<div class="card"><div class="label">Model</div><div class="value" style="color:' + color + '; font-size:1rem">' + hModel + '</div></div>';
      contentHtml += '<div class="card"><div class="label">Status</div><div class="value" style="color:#3fb950">Online</div></div>';
      contentHtml += '<div class="card"><div class="label">Port</div><div class="value" style="color:' + color + '">' + svc.port + '</div></div>';
      contentHtml += '</div>';
      contentHtml += '<div class="offline-msg">Metrics not available — apply the metrics patch to enable detailed stats</div>';
    } else {
      // Full metrics available
      contentHtml += '<div class="cards">';
      contentHtml += '<div class="card"><div class="label">Total Requests</div><div class="value" style="color:' + color + '">' + (s.total_requests || 0) + '</div></div>';
      contentHtml += '<div class="card"><div class="label">Avg Tok/s</div><div class="value" style="color:' + color + '">' + (s.avg_tokens_per_sec ? s.avg_tokens_per_sec.toFixed(2) : '0') + '</div></div>';
      contentHtml += '<div class="card"><div class="label">Total Prompt Tokens</div><div class="value" style="color:' + color + '">' + (s.total_prompt_tokens || 0).toLocaleString() + '</div></div>';
      contentHtml += '<div class="card"><div class="label">Total Completion Tokens</div><div class="value" style="color:' + color + '">' + (s.total_completion_tokens || 0).toLocaleString() + '</div></div>';
      contentHtml += '</div>';

      contentHtml += '<table><thead><tr>';
      contentHtml += '<th>Timestamp</th><th>Model</th><th class="num">Prompt</th>';
      contentHtml += '<th class="num">Completion</th><th class="num">Total</th>';
      contentHtml += '<th class="num">Latency (s)</th><th class="num">Tok/s</th>';
      contentHtml += '</tr></thead><tbody>';
      if (d.requests && d.requests.length > 0) {
        for (const m of d.requests.slice().reverse()) {
          contentHtml += '<tr>';
          contentHtml += '<td class="muted">' + m.timestamp + '</td>';
          contentHtml += '<td>' + m.model + '</td>';
          contentHtml += '<td class="num">' + m.prompt_tokens + '</td>';
          contentHtml += '<td class="num">' + m.completion_tokens + '</td>';
          contentHtml += '<td class="num">' + m.total_tokens + '</td>';
          contentHtml += '<td class="num">' + m.latency + '</td>';
          contentHtml += '<td class="num">' + m.tokens_per_sec + '</td>';
          contentHtml += '</tr>';
        }
      } else {
        contentHtml += '<tr><td colspan="7" class="offline-msg">Waiting for requests...</td></tr>';
      }
      contentHtml += '</tbody></table>';
    }

    div.innerHTML = contentHtml;
    panelsEl.appendChild(div);
  });
}

async function tryMetrics(p) {
  let metricsData = null;
  // Try /v1/metrics first (patched servers)
  try {
    const r = await fetch('http://localhost:' + p + '/v1/metrics', { signal: AbortSignal.timeout(8000) });
    const d = await r.json();
    if (d.summary) metricsData = { port: p, data: d, online: true };
  } catch(e) {}
  // Always try /health for model name
  try {
    const r = await fetch('http://localhost:' + p + '/health', { signal: AbortSignal.timeout(8000) });
    const d = await r.json();
    if (d.status) {
      if (metricsData) {
        metricsData.data.health_model = d.model || null;
        return metricsData;
      }
      return { port: p, data: { summary: null, health_model: d.model || null, requests: [] }, online: true, healthOnly: true };
    }
  } catch(e) {}
  return metricsData;
}

async function refresh() {
  const results = await Promise.all(SCAN_PORTS.map(p => tryMetrics(p)));
  const services = results.filter(r => r !== null);

  if (services.length === 0) {
    document.getElementById('tabs').innerHTML = '';
    document.getElementById('panels').innerHTML =
      '<div class="offline-msg">No MLX servers detected on ports 8080\u20138090</div>';
    document.getElementById('status').textContent = 'Scanning...';
    document.getElementById('status').style.color = '#f85149';
    return;
  }

  // Auto-select first tab if current selection is gone
  if (!activePort || !services.find(s => s.port === activePort)) {
    activePort = services[0].port;
  }

  renderTabs(services);
  renderPanels(services);
  document.getElementById('status').textContent =
    services.length + ' server' + (services.length > 1 ? 's' : '') + ' detected \u2022 polling every 2s';
  document.getElementById('status').style.color = '#3fb950';
}
refresh();
setInterval(refresh, 2000);
</script>
</body>
</html>
